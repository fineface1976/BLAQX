<!DOCTYPE html>
<html>
<head>
    <title>BLAQX User Dashboard</title>
    <base href="/BLAQX/">
    <style>
        :root {
            --primary: #116466;
            --accent: #FFCB9A;
            --text: white;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--primary);
            color: var(--text);
        }

        /* Dashboard Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .balance-card {
            background: rgba(0,0,0,0.3);
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem 0;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 2rem 0;
        }

        /* Transaction History */
        .tx-history {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 15px;
        }

        /* Hidden until auth check */
        body:not(.loaded) { display: none; }
    </style>
</head>
<body class="loaded">
    <!-- Auto Login Check -->
    <script>
        if (!localStorage.getItem('blaqxAuth')) {
            window.location.href = 'login.html';
        }
    </script>

    <nav style="display: flex; justify-content: space-between; align-items: center;">
        <h1>BLAQX Wallet</h1>
        <button onclick="logout()" style="padding: 0.5rem 1rem;">Logout</button>
    </nav>

    <div class="container">
        <!-- Balance Display -->
        <div class="balance-card">
            <h2>Available Balance</h2>
            <p id="balance">0.00 BLAQX ($0.00)</p>
        </div>

        <!-- Trading Actions -->
        <div class="quick-actions">
            <button onclick="initTrade('buy')">Buy BLAQX</button>
            <button onclick="initTrade('sell')">Sell BLAQX</button>
            <button onclick="showSendForm()">Send</button>
        </div>

        <!-- Referral System -->
        <div class="referral-box" style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 10px;">
            <h3>Your Referral Link</h3>
            <input type="text" id="refLink" readonly style="width: 300px; padding: 0.5rem;">
            <button onclick="copyRefLink()">Copy</button>
            <p>Earn 5% commission on referrals</p>
        </div>

        <!-- Transaction History -->
        <div class="tx-history">
            <h3>Recent Transactions</h3>
            <div id="txList"></div>
        </div>
    </div>

    <!-- Flutterwave Integration -->
    <script src="https://checkout.flutterwave.com/v3.js"></script>
    
    <!-- Unified System Script -->
    <script>
        // System Configuration
        const CONFIG = {
            tokenPrice: 0.50,
            refCommission: 0.05
        };

        // User State
        let user = JSON.parse(localStorage.getItem('blaqxUser') || {
            balance: 0,
            referrals: [],
            transactions: []
        };

        // Payment Handler
        function initTrade(action) {
            const amount = parseFloat(prompt(`Enter ${action} amount:`));
            if (amount > 0) {
                if (action === 'buy') {
                    processPayment(amount * CONFIG.tokenPrice);
                } else {
                    user.balance -= amount;
                    updateState();
                }
            }
        }

        function processPayment(amount) {
            FlutterwaveCheckout({
                public_key: localStorage.getItem('blaqxFlutterwaveKey') || 'FLWPUBK-TEST-XXXXXXXXXXXX-X',
                tx_ref: `BLAQX-${Date.now()}`,
                amount: amount,
                currency: 'USD',
                callback: function(response) {
                    if (response.status === 'successful') {
                        user.balance += amount / CONFIG.tokenPrice;
                        user.transactions.push({
                            type: 'deposit',
                            amount: amount,
                            date: new Date().toISOString()
                        });
                        updateState();
                    }
                }
            });
        }

        // Referral System
        function copyRefLink() {
            const link = document.getElementById('refLink');
            navigator.clipboard.writeText(link.value);
            alert('Referral link copied!');
        }

        // State Management
        function updateState() {
            // Update Balance
            document.getElementById('balance').textContent = 
                `${user.balance.toFixed(2)} BLAQX ($${(user.balance * CONFIG.tokenPrice).toFixed(2)})`;

            // Update Transactions
            document.getElementById('txList').innerHTML = user.transactions
                .map(tx => `<div>${new Date(tx.date).toLocaleDateString()} - ${tx.type} ${tx.amount}</div>`)
                .join('');

            // Save to Storage
            localStorage.setItem('blaqxUser', JSON.stringify(user));
        }

        // Initial Load
        document.getElementById('refLink').value = 
            `${window.location.origin}/register?ref=${user.id || 'guest'}`;
        updateState();

        // Logout
        function logout() {
            localStorage.removeItem('blaqxAuth');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
